!pip install ultralytics
'''
# Copy dowloadcode on Roboflow
!pip install roboflow
from roboflow import Roboflow
rf = Roboflow(api_key="xoNzVN4PxIdhCJt7K6nL")
project = rf.workspace("nckh2026").project("nckh26-hloi9")
version = project.version(1)
dataset = version.download("yolov12")
'''

from google.colab import drive

# Mount Google Drive
drive.mount('/content/drive')

# Táº O THÆ¯ Má»¤C NÃ€Y TRÆ¯á»šC TRÃŠN GOOGLE DRIVE Cá»¦A Báº N: "YOLOv12_Project"
ROOT_DIR = '/content/drive/MyDrive/YOLOv12_Project'

# Táº¡o folder náº¿u chÆ°a tá»“n táº¡i
!mkdir -p "{ROOT_DIR}"
%cd "{ROOT_DIR}"

from ultralytics import YOLO

# 1. Load model YOLOv12s-seg (Instance Segmentation)
# ThÆ° viá»‡n sáº½ tá»± Ä‘á»™ng táº£i weights náº¿u chÆ°a cÃ³
model = YOLO('/content/yolov12s-seg.pt') #Fix name of Model--

# 2. Tiáº¿n hÃ nh Train
results = model.train(
    data='/content/NCKH26-1/data.yaml',  # ÄÆ°á»ng dáº«n data.yaml Ä‘Ã£ Ä‘á»‹nh nghÄ©a
    task='segment',       # Quan trá»ng: chá»‰ Ä‘á»‹nh task lÃ  segmentation
    epochs=70,            # Sá»‘ epoch (tÃ¹y chá»‰nh)
    imgsz=640,            # KÃ­ch thÆ°á»›c áº£nh
    batch=16,             # Batch size (tÃ¹y chá»‰nh theo GPU)
    name='yolov12s_seg_colab', # TÃªn folder lÆ°u káº¿t quáº£ trong runs/segment/
    project=f'{ROOT_DIR}/runs/segment', # ÄÆ¯á»œNG DáºªN LÆ¯U VÃ€O GOOGLE DRIVE
    exist_ok=True
)

import os
import glob
import random
import matplotlib.pyplot as plt
import matplotlib.image as mpimg
from IPython.display import Image, display
from ultralytics import YOLO

# =================================================================
# 1. Äá»ŠNH NGHÄ¨A ÄÆ¯á»œNG DáºªN (Cáº§n kiá»ƒm tra láº¡i náº¿u báº¡n Ä‘áº·t tÃªn khÃ¡c)
# =================================================================
ROOT_DIR = '/content/drive/MyDrive/YOLOv12_Project'
# TÃªn folder káº¿t quáº£ train Ä‘Ã£ lÆ°u trong Drive (BÆ°á»›c 3)
TRAIN_RESULT_NAME = 'yolov12s_seg_colab'
RESULT_FOLDER = f'{ROOT_DIR}/runs/segment/{TRAIN_RESULT_NAME}'
BEST_MODEL_PATH = f'{RESULT_FOLDER}/weights/best.pt'

# ÄÆ°á»ng dáº«n Ä‘áº¿n folder áº£nh test (THAY THáº¾ ÄÆ¯á»œNG DáºªN NÃ€Y Vá»šI Cá»¦A Báº N)
TEST_SOURCE_PATH = '/content/NCKH26-1/test/images'
INFERENCE_OUTPUT_FOLDER = f'{ROOT_DIR}/runs/segment/predict_test'


# =================================================================
# 2. HIá»‚N THá»Š BIá»‚U Äá»’ Káº¾T QUáº¢ TRAIN (ÄÃ£ lÆ°u trong Drive)
# =================================================================
print("=========================================================")
print("             ğŸ“ˆ PHÃ‚N TÃCH Káº¾T QUáº¢ HUáº¤N LUYá»†N ğŸ“ˆ           ")
print("=========================================================")

# Hiá»ƒn thá»‹ Biá»ƒu Ä‘á»“ Loss vÃ  Metrics (results.png)
print("\n--- Biá»ƒu Ä‘á»“ Tá»•ng há»£p Loss vÃ  Metrics (mAP) ---")
try:
    display(Image(filename=f'{RESULT_FOLDER}/results.png'))
    
except FileNotFoundError:
    print(f"Lá»—i: KhÃ´ng tÃ¬m tháº¥y results.png táº¡i {RESULT_FOLDER}")
# Hiá»ƒn thá»‹ Ma tráº­n nháº§m láº«n (Confusion Matrix)
print("\n--- Ma tráº­n Nháº§m láº«n (Confusion Matrix Normalized) ---")
try:
    # ThÆ°á»ng lÃ  file normalized cho dá»… Ä‘á»c
    display(Image(filename=f'{RESULT_FOLDER}/confusion_matrix_normalized.png', width=800))
except FileNotFoundError:
    try:
        display(Image(filename=f'{RESULT_FOLDER}/confusion_matrix.png', width=800))
    except FileNotFoundError:
        print("Lá»—i: KhÃ´ng tÃ¬m tháº¥y Confusion Matrix.")

# Hiá»ƒn thá»‹ áº¢nh Validation máº«u (Ground Truth vs Prediction)
print("\n--- áº¢nh Validation Máº«u (Prediction trÃªn táº­p Val) ---")
try:
    val_images = glob.glob(f'{RESULT_FOLDER}/val_batch*_pred.jpg')
    if val_images:
        display(Image(filename=val_images[0], width=800))
except Exception:
    print("Lá»—i: KhÃ´ng tÃ¬m tháº¥y áº£nh Val máº«u.")


# =================================================================
# 3. ÄÃNH GIÃ VÃ€ XUáº¤T CHá»ˆ Sá» TEST CUá»I CÃ™NG (VAL)
# =================================================================
print("\n=========================================================")
print("            ğŸ“Š CHá»ˆ Sá» ÄÃNH GIÃ (Final Metrics) ğŸ“Š          ")
print("=========================================================")

try:
    # Load model tá»‘t nháº¥t Ä‘Ã£ lÆ°u vÃ o Drive
    best_model = YOLO(BEST_MODEL_PATH)
    print(f"ÄÃ£ load model tá»‘t nháº¥t tá»«: {BEST_MODEL_PATH}")
    
    # Cháº¡y Validation/Test trÃªn táº­p Validation Ä‘Ã£ cáº¥u hÃ¬nh trong data.yaml
    val_metrics = best_model.val()

    print("\n--- Káº¾T QUáº¢ CHÃNH TRÃŠN Táº¬P VALIDATION ---")
    print(f"âœ… mAP50 (Mask/Segmentation): {val_metrics.seg.map50:.4f}")
    print(f"âœ… mAP50-95 (Mask/Segmentation): {val_metrics.seg.map:.4f}")
    print(f"mAP50 (Box/Detection): {val_metrics.box.map50:.4f}")
    print(f"mAP50-95 (Box/Detection): {val_metrics.box.map:.4f}")
    
except FileNotFoundError:
    print(f"\nâŒ Lá»—i: KhÃ´ng tÃ¬m tháº¥y model {BEST_MODEL_PATH}. Vui lÃ²ng kiá»ƒm tra láº¡i Ä‘Æ°á»ng dáº«n.")
except Exception as e:
    print(f"\nâŒ Lá»—i trong quÃ¡ trÃ¬nh Ä‘Ã¡nh giÃ¡: {e}")


# =================================================================
# 4. CHáº Y INFERENCE VÃ€ HIá»‚N THá»Š Káº¾T QUáº¢ TEST
# =================================================================
print("\n=========================================================")
print("            ğŸ“¸ Káº¾T QUáº¢ Dá»° ÄOÃN TRÃŠN áº¢NH TEST ğŸ“¸           ")
print("=========================================================")

try:
    if 'best_model' in locals():
        # Cháº¡y dá»± Ä‘oÃ¡n trÃªn táº­p áº£nh TEST (káº¿t quáº£ Ä‘Æ°á»£c lÆ°u vÃ o Drive)
        print(f"Äang cháº¡y dá»± Ä‘oÃ¡n trÃªn áº£nh Test tá»« {TEST_SOURCE_PATH}...")
        best_model.predict(
            source=TEST_SOURCE_PATH,
            save=True,
            conf=0.5,
            iou=0.6,
            project=f'{ROOT_DIR}/runs/segment',
            name='predict_test', # TÃªn folder má»›i trong Drive
exist_ok=True
        )

        # Hiá»ƒn thá»‹ 3 áº£nh ngáº«u nhiÃªn Ä‘Ã£ Ä‘Æ°á»£c predict vÃ  lÆ°u trong Drive
        pred_test_images = glob.glob(f'{INFERENCE_OUTPUT_FOLDER}/*.jpg') + glob.glob(f'{INFERENCE_OUTPUT_FOLDER}/*.png')
        print(f"ÄÃ£ lÆ°u {len(pred_test_images)} áº£nh káº¿t quáº£ dá»± Ä‘oÃ¡n vÃ o Drive táº¡i: {INFERENCE_OUTPUT_FOLDER}")
        
        if pred_test_images:
            for img_path in random.sample(pred_test_images, min(len(pred_test_images), 3)):
                img = mpimg.imread(img_path)
                plt.figure(figsize=(10, 10))
                plt.imshow(img)
                plt.axis('off')
                plt.title(f"áº¢nh Test: {os.path.basename(img_path)}")
                plt.show()
        else:
            print("KhÃ´ng tÃ¬m tháº¥y áº£nh káº¿t quáº£ dá»± Ä‘oÃ¡n nÃ o Ä‘á»ƒ hiá»ƒn thá»‹.")
            
except Exception as e:
    print(f"\nâŒ Lá»—i trong quÃ¡ trÃ¬nh Inference: {e}")